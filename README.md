# pubWorkflow

pubWorkflow is a REST based API implemented in Python basing on Flask,  that can be used to support a two-step review process in [Dataverse](https://dataverse.org) based data repositories. 
The API is used in the [publication workflow of DaRUS](https://www.izus.uni-stuttgart.de/en/fokus/darus/publication/), the data repository of the University of Stuttgart. 

## Endpoints

- ```POST pubworkflow/$invocationID?authKey=<randomstring>``` : Endpoint called by Dataverse in the PrePublish-Workflow step to start a new Publication workflow. 
    Expected Parameters:
   - $invocationID: unique workflow id generated by Dataverse
   - authKey: random string configured in credentials.json (["darus"]["authKey"])

- ```PUT pubworkflow/$invocationID/?action=<ok|removeLock|addLock|cancel|validate>&authKey=<randomstring>``` : Endpoint called in the publication process to release and publish a dataset after curation (?action=ok), cancel the publication process and reset the dataset as unpublished (?action=cancel), revalidate the dataset (?action=validate), remove workflow locks to edit a dataset while curation (?action=removeLock) or add workflow locks again (?action=addLock) after the changes
    Expected parameters:
    - invocationId: workflow id
    - action: defines the action to execute on the workflow
    - authKey: random string configured in credentials.json (["curator"]["authKey"])


## pubWorkflow Installation and Configuration on the Server

To deploy pubWorkflow, you can either use gunicorn to run the service, install it as a systemd service or use the Docker file to run it as a docker container.

The tool can be configured via a credentials.json file and via environment variables


### Configure pubWorkflow
It is necessary to set up the configuration in the credentials.json file and via Python env variables.

#### Adjust credentials.json

Use the cred/credentials_default.json file, adjust it to your needs and rename it to credentials.json

credentials.json has different options for configuration for the "darus" object:
```
    "apiKey":"<add Dataverse API-Key>",
    "baseUrl":"https://nfldevdataverse3.rus.uni-stuttgart.de",
    "apiBaseUrl":"http://localhost:8080",
    "apiErrorMail":"http://localhost:8090",
    "authKey":"keWrKrjweILmewrEw",
    "mailer":"False",
    "debug":"True",
    "validation":"True"
    "validationJSON":"False"
```

The "apiKey" is crucial for pubWorkflow to work with Dataverse. Please use a key with admin context.

The "baseUrl" is the domain name of your Dataverse installation.

The "mailer" can be switched on or off (true|false) to activate or deactivate the sending of e-mails

The "debug" mode can be switched on or off (true|false).

The automatic "validation" of datasets can be switched on or off (true|false). 

If "validationJSON" is set to true, the validation results are attached to the information mail additionaly in form of structured JSON file (true|false).

If you want to use validation you have to install also pyDaRUS. If you do not need validation, you can remove the pyDaRUS requirement from requirements.txt

credentials.json has different options for configuration for the "curator" object:
```
    "email":"darus-test-publikation@izus.uni-stuttgart.de",
    "authKey":"jEvXsdCuWpIawE",
    "mailTpl":"tpl_mailToTeam3.txt",
    "mailHost":"localhost"
```

All auth keys should be renewed for a production system.

With "email" you can configure the recipients of pubWorkflow mails.

The "mailTpl" is the reference to the mail template file, that will be used to generate the information email for the curation team.

The "mailHost" is the hostname of the mail server. If you are running postfix on the same server as pubWorkflow. It is likely "localhost".



#### Define environment variables

Here is a list of necessary env variables
```
    URLPATH=pubWorkflow
    URLPATHERRORMAIL=pubWorkflowMail
    PORT=5000
    ADDRESS=127.0.0.1
    authKeyDaRUS=1234
    authKeyCurator=1234
    authKeyErrorMail=1234
```

ADDRESS and PORT are necessary if you want to use the Dockerfile in this repository to run pubWorkflow

### Run pubWorkflow as a Docker container

Run the following commands in the same folder where the Dockerfile is located

``` 
    docker build -t pubworkflow:latest
    docker run -d -p <hostPort>:5000 pubworkflow:latest 
```

### Run pubWorkflow via gunicorn

Otherwise, just run gunicorn on the command line in the same folder where the pubworkflowApi.py file is located:

   ``` gunicorn -b 127.0.0.1:5000 pubworkflowApi:app ```

### Configure workflow.json

To integrate pubWorkflow as a prePublish workflow step for Dataverse, adapt the 'workflow.json' in this repository to your needs and call the following curl command on your Dataverse Server:

    ```curl -XPOST -H "Content-Type: application/json" "http://localhost:8080/api/admin/workflows" -d "@workflow.json" | jq```

There will be a worfklow number returned which you can use to configure this uploaded workflow configuration as the default.

    curl -XPUT "http://localhost:8080/api/admin/workflows/default/PrePublishDataset" -d "3" | jq

### Running pubWorkflow behind an Apache as a Proxy

If you want to connect to pubWorkflow via an Apache server as a proxy, add the following lines in your Apache configuration

The ProxyPass config for the Dataverse server is:

    ProxyPass /pubWorkflow {{YOUR_SERVER_ADDRESS}}/pubWorkflow
    ProxyPassReverse /pubWorkflow {{YOUR_SERVER_ADDRESS}}/pubWorkflow

    ------

You can use an alternative url path for pubWorkflow

    "/__dataverse_tools__/pubWorkflow"

This is a URL path that can be freely selected and can be set as an Env variable in the Docker Compose.

#### Adjust IP Whitelist of your Dataverse Installation

The following command can be used to change the Dataverse IP whitelist in the case you are running pubWorkflow on a 
different server than the Dataverse installation:

    curl -XPUT http://localhost:8080/api/admin/workflows/ip-whitelist -d "127.0.0.1;::1"


## ðŸ‘« Authors

Florian Fritze - University Of Stuttgart <br>
Dorothea Iglezakis - University Of Stuttgart <br>
Anett Seeland - University Of Stuttgart <br>
